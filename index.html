<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="transparent">
    <title>Ben and Leah Wrapped</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --status-bar-color: transparent;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* SAFE AREA FIX: html background controls Safari status bar color */
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #333333;
            overscroll-behavior: none;
            background-color: transparent;
        }

        /* When Gallery is open, the ROOT must turn black */
        html.gallery-active {
            background-color: #000000 !important;
        }

        /* When Summary is open, the ROOT must turn blue */
        html.summary-active {
            background-color: #B8D4FF !important;
        }

        /* SAFE AREA FIX: Container has NO padding - safe-area padding is on children only */
        .wrapped-container {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            padding: 0;
            background: transparent;
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 20px 20px 10px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-left: calc(20px + env(safe-area-inset-left));
            padding-right: calc(20px + env(safe-area-inset-right));
            flex-shrink: 0;
        }

        .header h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 10vw;
            font-weight: 900;
            letter-spacing: 0;
            background: linear-gradient(135deg, #6495ED, #FFDAB9, #FFB6C1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 0.75rem;
            color: rgba(100, 149, 237, 0.7);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Card flip container */
        .card-container {
            flex: 1;
            display: flex;
            margin: 10px auto 20px;
            margin-left: max(16px, env(safe-area-inset-left));
            margin-right: max(16px, env(safe-area-inset-right));
            perspective: 1000px;
            min-height: 300px;
            max-height: 700px;
            position: relative;
            width: calc(100% - 32px - env(safe-area-inset-left) - env(safe-area-inset-right));
            max-width: 500px;
        }

        .card {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 24px;
            border: 1px solid rgba(100, 149, 237, 0.15);
            box-shadow: 0 8px 32px rgba(100, 149, 237, 0.15),
                        0 4px 12px rgba(0, 0, 0, 0.08),
                        0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .card-front {
            overflow: hidden;
            z-index: 2;
        }

        .card-back {
            transform: rotateY(180deg);
            overflow: visible;
        }

        /* Card backgrounds */
        .card-face {
            background: #ffffff;
        }

        /* Full-bleed image card style */
        .card-face.full-image .image-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            border-radius: 24px;
            overflow: hidden;
            flex: none;
        }

        .card-face.full-image .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 24px;
        }

        .card-face.full-image .card-date,
        .card-face.full-image .content,
        .card-face.full-image .flip-hint {
            position: relative;
            z-index: 2;
        }

        .card-face.full-image .card-date {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .card[data-card="0"] .card-front .card-date {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .card[data-card="4"] .card-front .card-date,
        .card[data-card="5"] .card-front .card-date {
            color: #000000;
            text-shadow: none;
        }

        .card[data-card="6"] .card-front .card-date {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .card-face.full-image .content {
            margin-top: auto;
            position: relative;
            padding: 20px 24px 4px;
            z-index: 2;
            order: 998;
        }

        .card-face.full-image .card-date {
            margin-top: 0;
        }

        .card-face.full-image::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 50%;
            background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.7));
            z-index: 1;
            pointer-events: none;
            border-radius: 0 0 24px 24px;
        }

        .card-face.full-image .story-text {
            color: #ffffff;
        }

        /* Video container for full-bleed video */
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 24px;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-face.full-image .story-text .highlight {
            color: #FFB6C1;
        }


        .card-face.full-image .flip-hint {
            color: rgba(255, 255, 255, 0.7);
        }

        .card-face.full-image .flip-hint svg {
            fill: rgba(255, 255, 255, 0.7);
        }

        /* Invisible ink effect */
        .invisible-ink-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            overflow: hidden;
            border-radius: 24px;
        }

        .invisible-ink-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .invisible-ink-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            z-index: 20;
            pointer-events: none;
            line-height: 1.3;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: #6495ED;
            padding: 24px 32px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: opacity 0.2s ease;
        }

        .invisible-ink-hint.hidden {
            opacity: 0;
        }

        .invisible-ink-hint svg {
            width: 48px;
            height: 48px;
            fill: #ffffff;
        }

        /* Message bubble styles */
        .message-chain {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 0;
            min-height: 0;
            max-height: 100%;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }

        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.ben {
            align-self: flex-end;
            background: #007AFF;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.leah {
            align-self: flex-start;
            background: #E5E5EA;
            color: #000;
            border-bottom-left-radius: 4px;
        }

        .message-context {
            align-self: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 0;
        }

        .image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 20px 10px;
            min-height: 0;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 16px;
        }

        .content {
            padding: 20px 24px 28px;
            flex-shrink: 0;
        }

        .card-date {
            font-family: 'Great Vibes', cursive;
            font-size: 1.8rem;
            font-weight: 400;
            text-align: center;
            padding: 8px 24px 16px;
            color: #6495ED;
            flex-shrink: 0;
            margin-top: auto;
            order: 999;
        }

        .event-tag {
            display: inline-block;
            background: linear-gradient(135deg, #FFB6C1, #FFDAB9);
            color: #5a4a4a;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 14px;
        }

        .story-text {
            font-size: 1.05rem;
            line-height: 1.6;
            color: #444444;
            font-weight: 400;
        }

        .story-text .highlight {
            color: #6495ED;
            font-weight: 600;
        }

        /* Back of card styles */
        .back-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px 28px;
            text-align: center;
        }

        .back-event-tag {
            display: inline-block;
            background: linear-gradient(135deg, #6495ED, #87CEEB);
            color: #ffffff;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 24px;
        }

        .back-story-text {
            font-size: 1.05rem;
            line-height: 1.7;
            color: #555555;
            font-weight: 400;
        }

        .back-story-text .highlight {
            color: #6495ED;
            font-weight: 600;
        }

        .back-story-text .highlight-pink {
            color: #DB7093;
            font-weight: 600;
        }

        .flip-hint {
            display: none;
        }

        .flip-hint svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .timeline-container {
            position: relative;
            padding: 0 40px 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            padding-left: calc(40px + env(safe-area-inset-left));
            padding-right: calc(40px + env(safe-area-inset-right));
            flex-shrink: 0;
        }

        .timeline-track {
            width: 100%;
            height: 4px;
            background: rgba(100, 149, 237, 0.15);
            border-radius: 2px;
            position: relative;
        }

        .timeline-fill {
            position: absolute;
            left: 5%;
            top: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFB6C1, #6495ED);
            border-radius: 2px;
            width: 0%;
            transition: width 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            will-change: width;
        }

        .timeline-milestones {
            position: absolute;
            top: -6px;
            left: 0;
            width: 100%;
            height: 16px;
        }

        .timeline-milestone {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(100, 149, 237, 0.3);
            border: 2px solid #ffffff;
            transform: translate(-50%, -50%);
            top: 50%;
            cursor: pointer;
            transition: width 0.2s cubic-bezier(0.4, 0.0, 0.2, 1),
                        height 0.2s cubic-bezier(0.4, 0.0, 0.2, 1),
                        box-shadow 0.2s cubic-bezier(0.4, 0.0, 0.2, 1),
                        background 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .timeline-milestone[data-milestone="0"] { left: 5%; }
        .timeline-milestone[data-milestone="1"] { left: 18%; }
        .timeline-milestone[data-milestone="2"] { left: 31%; }
        .timeline-milestone[data-milestone="3"] { left: 44%; }
        .timeline-milestone[data-milestone="4"] { left: 57%; }
        .timeline-milestone[data-milestone="5"] { left: 70%; }
        .timeline-milestone[data-milestone="6"] { left: 83%; }
        .timeline-milestone[data-milestone="7"] { left: 95%; }

        .timeline-milestone .heart-icon {
            display: none;
        }

        .timeline-milestone.passed:not(.active) {
            background: linear-gradient(135deg, #FFB6C1, #6495ED);
        }

        .timeline-milestone.active {
            background: transparent !important;
            border: 0 !important;
            border-color: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            width: 30px;
            height: 30px;
            animation: none !important;
        }

        .timeline-milestone.active .heart-icon {
            display: block;
            width: 100%;
            height: 100%;
            color: #FF1493;
            filter: drop-shadow(0 0 2px rgba(255, 182, 193, 0.6))
                    drop-shadow(0 0 4px rgba(255, 182, 193, 0.4))
                    drop-shadow(0 0 8px rgba(255, 105, 180, 0.3));
            animation: heart-pulse 1.5s ease-in-out infinite;
        }

        @keyframes heart-pulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(255, 182, 193, 0.6))
                        drop-shadow(0 0 4px rgba(255, 182, 193, 0.4))
                        drop-shadow(0 0 8px rgba(255, 105, 180, 0.3));
            }
            50% {
                transform: scale(1.15);
                filter: drop-shadow(0 0 3px rgba(255, 182, 193, 0.7))
                        drop-shadow(0 0 6px rgba(255, 182, 193, 0.5))
                        drop-shadow(0 0 12px rgba(255, 105, 180, 0.4));
            }
        }

        @keyframes milestone-glow {
            0%, 100% {
                box-shadow:
                    0 0 0 4px rgba(255, 182, 193, 0.3),
                    0 0 12px rgba(255, 182, 193, 0.5),
                    0 0 20px rgba(100, 149, 237, 0.3);
            }
            50% {
                box-shadow:
                    0 0 0 6px rgba(255, 182, 193, 0.4),
                    0 0 16px rgba(255, 182, 193, 0.6),
                    0 0 24px rgba(100, 149, 237, 0.4);
            }
        }

        @media screen and (max-height: 700px) {
            .header {
                padding: 12px 20px 8px;
                padding-top: calc(12px + env(safe-area-inset-top));
            }
            .header h1 {
                font-size: 1.4rem;
            }
            .card-container {
                margin: 8px 16px 16px;
            }
            .image-container {
                padding: 16px 16px 8px;
            }
            .content {
                padding: 16px 20px 20px;
            }
            .story-text,
            .back-story-text {
                font-size: 0.95rem;
            }
            .back-content {
                padding: 24px 20px;
            }
        }

        /* Navigation buttons - hidden on mobile */
        .nav-buttons {
            position: absolute;
            top: 50%;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 8px;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 10;
        }

        @media screen and (min-width: 768px) {
            .nav-buttons {
                display: flex;
            }
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(100, 149, 237, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: all;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(100, 149, 237, 0.1);
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-btn:disabled:hover {
            transform: none;
            background: rgba(255, 255, 255, 0.9);
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
            fill: #6495ED;
        }

        .card.hidden {
            display: none;
        }

        .card.slide-out-left {
            animation: slideOutLeft 0.3s ease-out forwards;
        }

        .card.slide-out-right {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        .card.slide-in-left {
            animation: slideInLeft 0.3s ease-out forwards;
        }

        .card.slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideOutLeft {
            from { transform: translateX(0) scale(1); opacity: 1; }
            to { transform: translateX(-30%) scale(0.85); opacity: 0; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0) scale(1); opacity: 1; }
            to { transform: translateX(30%) scale(0.85); opacity: 0; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(30%) scale(0.85); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(-30%) scale(0.85); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .header {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Gallery button */
        .gallery-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .gallery-btn:hover {
            transform: scale(1.1);
            background: #ffffff;
        }

        .gallery-btn svg {
            width: 24px;
            height: 24px;
            fill: #000000;
        }

        /* Gallery - body NEVER scrolls */
        body.gallery-open .wrapped-container {
            display: none;
        }

        body.gallery-open .gallery-overlay {
            display: block;
        }

        /* Gallery popup - no overlay needed, body background handles it */
        .gallery-overlay {
            display: none;
        }

        /* Gallery content - fixed scroll container */
        .gallery-content {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1001;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 60px 16px 40px;
            padding-top: calc(60px + env(safe-area-inset-top));
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
            background: #000000;
        }

        body.gallery-open .gallery-content {
            display: block;
        }

        .gallery-close {
            position: fixed;
            top: calc(16px + env(safe-area-inset-top));
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1002;
            transition: background 0.2s ease;
        }

        body.gallery-open .gallery-close {
            display: flex;
        }

        .gallery-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .gallery-close svg {
            width: 28px;
            height: 28px;
            fill: #ffffff;
        }

        .gallery-title {
            font-family: 'Great Vibes', cursive;
            font-size: 2rem;
            color: #ffffff;
            text-align: center;
            margin-bottom: 24px;
        }

        .gallery-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        .gallery-item {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .gallery-item img {
            width: 100%;
            display: block;
        }

        /* Wrapped Summary Card Styles */
        .wrapped-summary-card {
            background: linear-gradient(135deg, #6495ED 0%, #DB7093 50%, #FFB6C1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wrapped-summary-prompt {
            text-align: center;
            padding: 40px;
        }

        .wrapped-prompt-title {
            font-family: 'Great Vibes', cursive;
            font-size: 2.5rem;
            color: #ffffff;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .wrapped-prompt-text {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .wrapped-summary-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #ffffff;
            color: #6495ED;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .wrapped-summary-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .wrapped-summary-btn svg {
            width: 20px;
            height: 20px;
            fill: #6495ED;
        }

        /* Wrapped Summary - body NEVER scrolls */
        body.summary-open .wrapped-container {
            display: none;
        }

        .summary-content {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1001;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: calc(60px + env(safe-area-inset-top)) 16px calc(60px + env(safe-area-inset-bottom));
            background: #B8D4FF;
        }

        body.summary-open .summary-content {
            display: block;
        }

        .summary-close {
            position: fixed;
            top: calc(16px + env(safe-area-inset-top));
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1002;
            transition: background 0.2s ease;
        }

        body.summary-open .summary-close {
            display: flex;
        }

        .summary-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .summary-close svg {
            width: 28px;
            height: 28px;
            fill: #ffffff;
        }

        .summary-title {
            font-family: 'Great Vibes', cursive;
            font-size: 2.5rem;
            color: #ffffff;
            text-align: center;
            margin-bottom: 40px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .summary-stats {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 400px;
            margin: 0 auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            transition: opacity 0.4s ease-out, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .stat-card.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            color: #6495ED;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 1rem;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }

        .stat-list {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.8;
        }

        .stat-list div {
            padding: 4px 0;
            border-bottom: 1px solid rgba(100, 149, 237, 0.1);
        }

        .stat-list div:last-child {
            border-bottom: none;
        }

        /* SAFE AREA FIX: Background layer is FIXED to extend into safe areas */
        /* This is the ONLY element that provides the gradient background */
        #bleed-layer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            pointer-events: none;
            background: transparent;
        }

        /* Floating hearts background - fixed to extend into safe areas */
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: visible;
        }

        .heart {
            position: absolute;
            top: 0;
            opacity: 0;
            animation: floatUp linear infinite;
        }

        .heart svg {
            fill: currentColor;
        }

        /* Animate hearts floating up through the viewport */
        @keyframes floatUp {
            0% {
                transform: translateY(100vh);
                opacity: 0;
            }
            5% {
                opacity: 0.3;
            }
            95% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh);
                opacity: 0;
            }
        }

        /* Confetti styles */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        .confetti.animate {
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-20px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Particle Canvas */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* iOS Motion Permission Button */
        #motionPermissionBtn {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #6495ED, #FFB6C1);
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(100, 149, 237, 0.4);
            cursor: pointer;
            z-index: 10000;
            animation: pulse 2s infinite;
            bottom: calc(40px + env(safe-area-inset-bottom));
        }

        #motionPermissionBtn:active {
            transform: translateX(-50%) scale(0.95);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(100, 149, 237, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(100, 149, 237, 0.7);
            }
        }
    </style>
</head>
<body>
    <!-- Full-bleed layer (NOT fixed) to avoid iOS Safari compositing clipping -->
    <div id="bleed-layer">
        <!-- Floating hearts background -->
        <div class="floating-hearts" id="floatingHearts"></div>
    </div>

    <!-- Confetti container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <div class="wrapped-container" id="wrappedContainer">
        <header class="header">
            <h1>Ben and Leah Wrapped</h1>
        </header>

        <div class="card-container">
            <!-- Navigation buttons -->
            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn" onclick="navigateCard(-1)">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
                <button class="nav-btn" id="nextBtn" onclick="navigateCard(1)">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </button>
            </div>

            <!-- January 2019: First Encounter -->
            <div class="card" data-card="0" onclick="flipCard0(this)">
                <!-- Front of card -->
                <div class="card-face card-front full-image">
                    <div class="card-date">January 27th, 2019</div>
                    <div class="image-container">
                        <img src="assets/ParkingLotEncounter.png" alt="Parking lot where Ben and Leah first met">
                    </div>
                    <div class="content">
                        <span class="event-tag">First Encounter</span>
                        <p class="story-text">
                            Ben and his friends heard two girls screaming <span class="highlight">Sue Me</span> by Sabrina Carpenter in their car.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back full-image">
                    <div class="video-container">
                        <video id="parkingLotVideo" playsinline loop>
                            <source src="assets/ParkingLotEncounter.mov" type="video/quicktime">
                            <source src="assets/ParkingLotEncounter.mov" type="video/mp4">
                        </video>
                    </div>
                    <div class="content">
                        <span class="event-tag">The Beginning</span>
                        <p class="story-text">
                            Somehow they ended up in the girls' car, sang and danced together for a bit, and followed each other on <span class="highlight-pink">Instagram</span>.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- May 3, 2023: First Date at Color Me Mine -->
            <div class="card hidden" data-card="1" onclick="this.classList.toggle('flipped')">
                <!-- Front of card -->
                <div class="card-face card-front">
                    <div class="card-date">May 3, 2023</div>
                    <div class="image-container">
                        <img src="assets/FirstDateBowls.png" alt="Ice cream bowls painted at Color Me Mine on Ben and Leah's first date">
                    </div>
                    <div class="content">
                        <span class="event-tag">First Date</span>
                        <p class="story-text">
                            <span class="highlight">4</span> years later, with a friendly nudge from mutual friends, Ben asked Leah out. Their first date was spent painting ice cream bowls at <span class="highlight">Color Me Mine</span>.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back">
                    <div class="back-content">
                        <span class="back-event-tag">The Aftermath</span>
                        <p class="back-story-text">
                            Ben attempted to return the ice cream bowl to Leah but she <span class="highlight-pink">kindly refused</span> further dates and Ben eventually gave up hope of another date and threw away both bowls <span class="highlight">5 months later</span>.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- May 2023: Ghosted -->
            <div class="card hidden" data-card="2" onclick="this.classList.toggle('flipped')">
                <!-- Front of card -->
                <div class="card-face card-front">
                    <div class="card-date">May 2023</div>
                    <div class="image-container">
                        <img src="assets/SadGhost.png" alt="Sad ghost representing Ben being ghosted">
                    </div>
                    <div class="content">
                        <span class="event-tag">Ghosted</span>
                        <p class="story-text">
                            <span class="highlight">Leah ghosted Ben.</span> At least ghosts are transparent about their intentions...
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back">
                    <div class="card-date">The Receipts</div>
                    <p style="font-size: 0.7rem; color: #888; text-align: center; margin: 8px 16px 0; font-style: italic;">actual messages</p>
                    <div class="message-chain" onclick="event.stopPropagation()">
                        <div class="message ben">How about I come after you get home if ur not too busy! I'll bring ice cream!</div>
                        <div class="message leah">ok today is kinda nuts for me. Another day?</div>
                        <div class="message-context">ANOTHER DAY...</div>
                        <div class="message ben">Would 6 work?</div>
                        <div class="message leah">and my parents actually just got to town and we're all gonna go meet the baby tn</div>
                        <div class="message leah">so i need to leave my apt at 6ðŸ˜­ so tn isn't gonna work after all i'm so sorry!</div>
                        <div class="message leah">this week is crazy for me</div>
                        <div class="message-context">ANOTHER DAY...</div>
                        <div class="message ben">I know tmrw is Memorial Day and ur "not the biggest pick ball gal" but i say let's playâ€¦</div>
                        <div class="message leah">i'm working at the golf course all day tomorrowðŸ˜­</div>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- January 12, 2024: Mini Golf Date -->
            <div class="card hidden" data-card="3" onclick="flipCard2(this)">
                <!-- Front of card -->
                <div class="card-face card-front full-image">
                    <div class="card-date">January 12, 2024</div>
                    <div class="image-container">
                        <img src="assets/FirstDateMiniGolf.jpg" alt="Ben and Leah at mini golf on January 12th, 2024">
                    </div>
                    <div class="content">
                        <span class="event-tag">First (Consensual) Photo Together</span>
                        <p class="story-text">
                            After coming to her senses, Leah asked Ben out to mini golf.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back full-image">
                    <div class="card-date">September 11, 2022</div>
                    <div class="image-container">
                        <img src="assets/FirstPhotoTogether.jpg" alt="Ben and Leah's first photo together">
                    </div>
                    <!-- Invisible ink overlay -->
                    <div class="invisible-ink-container" id="invisibleInk">
                        <canvas id="inkCanvas"></canvas>
                        <div class="invisible-ink-hint">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20.5 9.5c-.28 0-.55.04-.81.1L16 8.71V5.5c0-.83-.67-1.5-1.5-1.5S13 4.67 13 5.5v8.17l-2.09-2.09c-.56-.56-1.46-.56-2.02 0-.26.26-.39.6-.39.94 0 .35.14.68.39.94l5.68 5.68c.39.39.9.59 1.41.59h4.17c1.38 0 2.5-1.12 2.5-2.5v-5.23c0-.83-.67-1.5-1.5-1.5h-.15zM4 13h2V5H4v8zm-2 2h2V3H2v12z"/>
                            </svg>
                            <span>Swipe To<br>Reveal</span>
                        </div>
                    </div>
                    <div class="content">
                        <span class="event-tag">First Photo Together</span>
                        <p class="story-text">
                            Technically this is... but who's keeping count?
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- February 14, 2024: Valentine's Day -->
            <div class="card hidden" data-card="4" onclick="this.classList.toggle('flipped')">
                <!-- Front of card -->
                <div class="card-face card-front">
                    <div class="card-date">February 14, 2024</div>
                    <div class="image-container">
                        <img src="assets/GirlfriendWatercolor.png" alt="Valentine's Day">
                    </div>
                    <div class="content">
                        <span class="event-tag">Valentine's Day</span>
                        <p class="story-text">
                            Their first <span class="highlight">Valentine's Day</span> together.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back">
                    <div class="back-content">
                        <span class="back-event-tag">Official</span>
                        <p class="back-story-text">
                            Ben asked Leah to be his <span class="highlight-pink">girlfriend</span>.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- August 29, 2024: California Road Trip -->
            <div class="card hidden" data-card="5" onclick="this.classList.toggle('flipped')">
                <!-- Front of card -->
                <div class="card-face card-front">
                    <button class="gallery-btn" onclick="event.stopPropagation(); openCaliforniaGallery();">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/>
                        </svg>
                    </button>
                    <div class="card-date">August 29, 2024</div>
                    <div class="image-container">
                        <img src="assets/RoadTripWatercolor.png" alt="Ben and Leah on their California road trip">
                    </div>
                    <div class="content">
                        <span class="event-tag">First Road Trip</span>
                        <p class="story-text">
                            Ben and Leah embarked on their first <span class="highlight">road trip together</span> to California, visiting hometowns and making memories.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back">
                    <div class="back-content">
                        <span class="back-event-tag">The Adventure</span>
                        <p class="back-story-text">
                            From <span class="highlight">Disneyland</span> to beach bike rides, from <span class="highlight">Bob's Big Boy</span> to swan boat dates at Echo Park, they explored Ben's childhood stomping grounds and created their own California memories together.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- November 13, 2024: The Proposal -->
            <div class="card hidden" data-card="6" onclick="this.classList.toggle('flipped')">
                <!-- Front of card -->
                <div class="card-face card-front full-image">
                    <button class="gallery-btn" onclick="event.stopPropagation(); openGallery();">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/>
                        </svg>
                    </button>
                    <div class="card-date">November 13, 2025</div>
                    <div class="image-container">
                        <img src="assets/EngagementWatercolor.png" alt="Ben and Leah's engagement">
                    </div>
                    <div class="content">
                        <span class="event-tag">She Said Yes!</span>
                        <p class="story-text">
                            After <span class="highlight">nearly 2 years</span> of dating, Ben popped the question in a park up Provo Canyon.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip
                    </div>
                </div>

                <!-- Back of card -->
                <div class="card-face card-back">
                    <div class="back-content">
                        <span class="back-event-tag">The Secret Mission</span>
                        <p class="back-story-text">
                            Ben had a ring and a problem: take Leah anywhere pretty and she'd <span class="highlight-pink">totally know</span>. So he enlisted her work, <span class="highlight">Cords Club</span>, to stage a "fall photoshoot" for an earring collection. While Leah wandered through the park scouting the perfect shot... Ben appeared out of nowhere. She had <span class="highlight-pink">absolutely no clue</span>. Mission accomplished.
                        </p>
                    </div>
                    <div class="flip-hint">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 6V4l-4 4 4 4V9.5c2.5 0 4.5 2 4.5 4.5s-2 4.5-4.5 4.5-4.5-2-4.5-4.5H6c0 3.3 2.7 6 6 6s6-2.7 6-6-2.7-6-6-6z"/>
                        </svg>
                        Tap to flip back
                    </div>
                </div>
            </div>

            <!-- Final Card: See Your Wrapped -->
            <div class="card hidden" data-card="7">
                <div class="card-face card-front wrapped-summary-card">
                    <div class="wrapped-summary-prompt">
                        <h2 class="wrapped-prompt-title">Your Story So Far</h2>
                        <p class="wrapped-prompt-text">From a parking lot singalong to forever.</p>
                        <button class="wrapped-summary-btn" onclick="event.stopPropagation(); openWrappedSummary();">
                            <span>See Your Wrapped</span>
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="timeline-track"></div>
            <div class="timeline-fill" id="timelineFill"></div>
            <div class="timeline-milestones">
                <div class="timeline-milestone active passed" data-milestone="0" onclick="jumpToCard(0)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="1" onclick="jumpToCard(1)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="2" onclick="jumpToCard(2)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="3" onclick="jumpToCard(3)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="4" onclick="jumpToCard(4)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="5" onclick="jumpToCard(5)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="6" onclick="jumpToCard(6)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="timeline-milestone" data-milestone="7" onclick="jumpToCard(7)">
                    <svg class="heart-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery - Fixed background overlay -->
    <div class="gallery-overlay" id="galleryOverlay"></div>

    <!-- Gallery - Close button (fixed) -->
    <button class="gallery-close" onclick="closeGallery()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
    </button>

    <!-- Gallery - Content (scrolls with body) -->
    <div class="gallery-content" id="engagementGallery">
        <h2 class="gallery-title">The Proposal</h2>
        <div class="gallery-grid">
            <div class="gallery-item">
                <img src="assets/EngagementWatercolor.png" alt="Engagement photo">
            </div>
            <div class="gallery-item">
                <img src="assets/EngagementWatercolor.png" alt="Engagement photo 2">
            </div>
            <div class="gallery-item">
                <img src="assets/EngagementWatercolor.png" alt="Engagement photo 3">
            </div>
        </div>
    </div>

    <!-- California Gallery - Content (scrolls with body) -->
    <div class="gallery-content" id="californiaGallery" style="display: none;">
        <h2 class="gallery-title">California Road Trip</h2>
        <div class="gallery-grid">
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/1. RoadTrip.JPG" alt="Road trip adventure">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/2. SwanLeah.JPG" alt="Leah on swan boat">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/3. SwanDate.jpg" alt="Swan boat date at Echo Park">
            </div>
            <div class="gallery-item">
                <video id="californiaVideo" autoplay muted playsinline style="width: 100%; border-radius: 16px;">
                    <source src="assets/CaliforniaTrip/4. Skyline Transition V4.mov" type="video/quicktime">
                    <source src="assets/CaliforniaTrip/4. Skyline Transition V4.mov" type="video/mp4">
                </video>
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/5. SelfieElysianPark.JPG" alt="Selfie at Elysian Park">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/6. Autopia.JPG" alt="Autopia at Disneyland">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/7. Disneyland.JPG" alt="Disneyland">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/8. BeachBikeRide.JPG" alt="Beach bike ride">
            </div>
            <div class="gallery-item">
                <img src="assets/CaliforniaTrip/9. BobsBigBoys.JPG" alt="Bob's Big Boy">
            </div>
        </div>
    </div>

    <!-- Wrapped Summary - Close button (fixed) -->
    <button class="summary-close" onclick="closeWrappedSummary()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
    </button>

    <!-- Wrapped Summary - Content (scrolls with body) -->
    <div class="summary-content">
        <h2 class="summary-title">Ben & Leah Wrapped</h2>
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-value" id="statDaysKnown">---</div>
                <div class="stat-label">Days Known</div>
                <div class="stat-subtitle">Since January 27, 2019</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statDaysDated">---</div>
                <div class="stat-label">Days Dated</div>
                <div class="stat-subtitle">Since February 14, 2024</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statDaysEngaged">---</div>
                <div class="stat-label">Days Engaged</div>
                <div class="stat-subtitle">Since November 13, 2025</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">8</div>
                <div class="stat-label">States Visited</div>
                <div class="stat-list">
                    <div>Minnesota</div>
                    <div>California</div>
                    <div>Texas</div>
                    <div>Florida</div>
                    <div>Utah</div>
                    <div>Arizona</div>
                    <div>Alabama</div>
                    <div>Colorado</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">6</div>
                <div class="stat-label">Concerts Attended</div>
                <div class="stat-list">
                    <div>Jeremy Zucker & Chelsea Cutler</div>
                    <div>Tate McRae</div>
                    <div>Post Malone</div>
                    <div>Dan + Shay</div>
                    <div>Sundance Bluebird Cafe</div>
                    <div>Jonas Brothers</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Particle Canvas -->
    <canvas id="particleCanvas"></canvas>

    <!-- iOS Motion Permission Button (hidden by default) -->
    <button id="motionPermissionBtn" style="display: none;">
        Tap to Enable Motion
    </button>

    <script>
        // Key dates - edit these to update stats
        const DATE_FIRST_MET = '2019-01-27';
        const DATE_STARTED_DATING = '2024-02-14';
        const DATE_ENGAGED = '2025-11-13';

        // Helper to update theme color (affects iOS Safari status bar)
        function setThemeColor(color) {
            console.log('setThemeColor called with:', color); // Debug

            // Method 1: Update theme-color meta tag
            const themeColorMeta = document.getElementById('themeColor');
            themeColorMeta.setAttribute('content', color);

            // Method 2: Remove and re-add the meta tag (forces Safari to re-read)
            const newMeta = themeColorMeta.cloneNode(true);
            newMeta.setAttribute('content', color);
            themeColorMeta.parentNode.replaceChild(newMeta, themeColorMeta);
            newMeta.id = 'themeColor';

            // Method 3: Update CSS variable
            document.documentElement.style.setProperty('--status-bar-color', color);

            // Method 4: Direct inline style on html (highest specificity)
            // For transparent, remove inline styles to let CSS take over
            if (color === 'transparent') {
                document.documentElement.style.removeProperty('background-color');
                document.body.style.removeProperty('background-color');
            } else {
                document.documentElement.style.backgroundColor = color;
                document.body.style.backgroundColor = color;
            }

            // Force repaint
            void document.documentElement.offsetHeight;
        }

        // Gallery functions
        function openGallery() {
            document.getElementById('engagementGallery').style.display = 'block';
            document.getElementById('californiaGallery').style.display = 'none';
            document.documentElement.classList.add('gallery-active');
            document.body.classList.add('gallery-open');
            document.getElementById('bleed-layer').style.display = 'none';

            // Force a theme-color update for the notch
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
        }

        let boomerangInterval = null;

        function openCaliforniaGallery() {
            document.getElementById('engagementGallery').style.display = 'none';
            document.getElementById('californiaGallery').style.display = 'block';
            document.documentElement.classList.add('gallery-active');
            document.body.classList.add('gallery-open');
            document.getElementById('bleed-layer').style.display = 'none';

            // Force a theme-color update for the notch
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');

            // Start boomerang effect for video
            const video = document.getElementById('californiaVideo');
            if (video) {
                let isReversing = false;
                const fps = 30;
                const frameTime = 1 / fps;

                video.play();

                // Clear any existing interval
                if (boomerangInterval) {
                    clearInterval(boomerangInterval);
                }

                // Boomerang effect using manual frame stepping
                video.addEventListener('ended', function() {
                    isReversing = true;
                    boomerangInterval = setInterval(() => {
                        if (isReversing) {
                            video.currentTime = Math.max(0, video.currentTime - frameTime);
                            if (video.currentTime <= 0) {
                                isReversing = false;
                                clearInterval(boomerangInterval);
                                video.play();
                            }
                        }
                    }, 1000 / fps);
                });
            }
        }

        function closeGallery() {
            // Hide both galleries
            document.getElementById('engagementGallery').style.display = 'none';
            document.getElementById('californiaGallery').style.display = 'none';

            document.documentElement.classList.remove('gallery-active');
            document.body.classList.remove('gallery-open');
            document.getElementById('bleed-layer').style.display = '';

            // Explicitly reset background
            document.documentElement.style.backgroundColor = 'transparent';

            document.querySelector('meta[name="theme-color"]').setAttribute('content', 'transparent');
        }

        // Ensure gallery and summary are closed on page load (fixes refresh issue)
        document.body.classList.remove('gallery-open');
        document.body.classList.remove('summary-open');

        // Close gallery on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeGallery();
                closeWrappedSummary();
            }
        });

        // Wrapped Summary functions
        function openWrappedSummary() {
            document.documentElement.classList.add('summary-active');
            document.body.classList.add('summary-open');
            document.getElementById('bleed-layer').style.display = 'none';

            // Force a theme-color update
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#B8D4FF');

            // Animate stat cards on scroll
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => card.classList.remove('visible'));

            setTimeout(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry, index) => {
                        if (entry.isIntersecting) {
                            setTimeout(() => {
                                entry.target.classList.add('visible');
                            }, index * 100);
                        }
                    });
                }, { threshold: 0.2 });

                statCards.forEach(card => observer.observe(card));
            }, 100);

            // Calculate all date-based stats
            const today = new Date();

            const daysKnown = Math.floor((today - new Date(DATE_FIRST_MET)) / (1000 * 60 * 60 * 24));
            document.getElementById('statDaysKnown').textContent = daysKnown.toLocaleString();

            const daysDated = Math.floor((today - new Date(DATE_STARTED_DATING)) / (1000 * 60 * 60 * 24));
            document.getElementById('statDaysDated').textContent = daysDated.toLocaleString();

            const daysEngaged = Math.floor((today - new Date(DATE_ENGAGED)) / (1000 * 60 * 60 * 24));
            document.getElementById('statDaysEngaged').textContent = daysEngaged.toLocaleString();
        }

        function closeWrappedSummary() {
            document.documentElement.classList.remove('summary-active');
            document.body.classList.remove('summary-open');
            document.getElementById('bleed-layer').style.display = '';

            // Explicitly reset background
            document.documentElement.style.backgroundColor = 'transparent';

            document.querySelector('meta[name="theme-color"]').setAttribute('content', 'transparent');
        }

        let currentCardIndex = 0;
        const cards = document.querySelectorAll('.card');
        const totalCards = cards.length;
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const timelineMilestones = document.querySelectorAll('.timeline-milestone');
        const timelineFill = document.getElementById('timelineFill');

        function updateTimelineProgress(progress, useTransition = false) {
            // Timeline spans from 5% to 95% (90% total range)
            const fillWidth = Math.max(0, Math.min(90, progress * 90));

            if (useTransition) {
                timelineFill.style.transition = 'width 0.2s cubic-bezier(0.4, 0.0, 0.2, 1)';
            } else {
                timelineFill.style.transition = 'none';
            }

            timelineFill.style.width = fillWidth + '%';
        }

        function updateCard() {
            // Hide all cards and remove flipped state
            cards.forEach((card, index) => {
                if (index === currentCardIndex) {
                    card.classList.remove('hidden');
                    card.classList.remove('flipped'); // Reset flip state when navigating
                } else {
                    card.classList.add('hidden');
                }
            });

            // Update navigation buttons
            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.disabled = currentCardIndex === totalCards - 1;

            // Update timeline milestones
            timelineMilestones.forEach((milestone, index) => {
                if (index === currentCardIndex) {
                    milestone.classList.add('active');
                    milestone.classList.add('passed');
                } else if (index < currentCardIndex) {
                    milestone.classList.remove('active');
                    milestone.classList.add('passed');
                } else {
                    milestone.classList.remove('active', 'passed');
                }
            });

            // Update timeline fill
            const progress = currentCardIndex / (totalCards - 1);
            updateTimelineProgress(progress, true);
        }

        function jumpToCard(targetIndex) {
            if (targetIndex === currentCardIndex || targetIndex < 0 || targetIndex >= totalCards) {
                return; // Already on this card or invalid index
            }

            // Pause video if leaving card 0
            if (currentCardIndex === 0 && parkingLotVideo) {
                parkingLotVideo.pause();
                parkingLotVideo.currentTime = 0;
            }

            // Update current card index
            currentCardIndex = targetIndex;

            // Update card visibility and timeline
            updateCard();

            // Initialize invisible ink if jumping to card 3
            if (currentCardIndex === 3 && typeof initInvisibleInk === 'function') {
                initInvisibleInk();
            }
        }

        function navigateCard(direction) {
            const newIndex = currentCardIndex + direction;
            if (newIndex >= 0 && newIndex < totalCards) {
                const currentCard = cards[currentCardIndex];
                const nextCard = cards[newIndex];

                // Pause video if leaving card 0
                if (currentCardIndex === 0 && parkingLotVideo) {
                    parkingLotVideo.pause();
                    parkingLotVideo.currentTime = 0;
                }

                // Remove any existing animation classes
                currentCard.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                nextCard.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right', 'hidden');

                // Add animation classes based on direction
                if (direction > 0) {
                    // Going forward (swipe left)
                    currentCard.classList.add('slide-out-left');
                    nextCard.classList.add('slide-in-left');
                } else {
                    // Going backward (swipe right)
                    currentCard.classList.add('slide-out-right');
                    nextCard.classList.add('slide-in-right');
                }

                // After animation, update state
                setTimeout(() => {
                    currentCard.classList.add('hidden');
                    currentCard.classList.remove('slide-out-left', 'slide-out-right', 'flipped');
                    nextCard.classList.remove('slide-in-left', 'slide-in-right');
                    currentCardIndex = newIndex;

                    // Update navigation buttons
                    prevBtn.disabled = currentCardIndex === 0;
                    nextBtn.disabled = currentCardIndex === totalCards - 1;

                    // Update timeline milestones
                    timelineMilestones.forEach((milestone, index) => {
                        if (index === currentCardIndex) {
                            milestone.classList.add('active');
                            milestone.classList.add('passed');
                        } else if (index < currentCardIndex) {
                            milestone.classList.remove('active');
                            milestone.classList.add('passed');
                        } else {
                            milestone.classList.remove('active', 'passed');
                        }
                    });

                    // Update timeline fill
                    const progress = currentCardIndex / (totalCards - 1);
                    updateTimelineProgress(progress, true);

                    // Initialize invisible ink if we're on card 3
                    if (currentCardIndex === 3 && typeof initInvisibleInk === 'function') {
                        initInvisibleInk();
                    }
                }, 300);
            }
        }

        // Initialize on page load
        updateCard();

        // Swipe gesture support with partial drag
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isDragging = false;
        let touchStartedInScrollable = false;
        let touchStartedInInk = false;
        const cardContainer = document.querySelector('.card-container');
        const swipeThreshold = 80; // minimum distance to complete swipe

        cardContainer.addEventListener('touchstart', (e) => {
            // Check if touch started in a scrollable element or invisible ink
            touchStartedInScrollable = e.target.closest('.message-chain') !== null;
            touchStartedInInk = e.target.closest('.invisible-ink-container') !== null;

            if (touchStartedInScrollable || touchStartedInInk) return;

            touchStartX = e.changedTouches[0].screenX;
            touchCurrentX = touchStartX;
            isDragging = true;

            // Disable transition during drag
            const currentCard = cards[currentCardIndex];
            currentCard.style.transition = 'none';
        }, { passive: true });

        cardContainer.addEventListener('touchmove', (e) => {
            if (!isDragging || touchStartedInScrollable || touchStartedInInk) return;

            touchCurrentX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchCurrentX;
            const containerWidth = cardContainer.offsetWidth;
            const progress = Math.min(Math.max(diff / containerWidth, -1), 1);

            // Update timeline fill in real-time during drag
            const dragProgress = diff / containerWidth;
            const continuousProgress = Math.max(0, Math.min(1,
                (currentCardIndex + dragProgress) / (totalCards - 1)
            ));
            updateTimelineProgress(continuousProgress, false);

            const currentCard = cards[currentCardIndex];
            const nextIndex = currentCardIndex + (diff > 0 ? 1 : -1);
            const nextCard = cards[nextIndex];

            // Apply transform to current card
            const currentScale = 1 - Math.abs(progress) * 0.15;
            const currentTranslate = -progress * 30;
            const currentOpacity = 1 - Math.abs(progress) * 0.5;
            currentCard.style.transform = `translateX(${currentTranslate}%) scale(${currentScale})`;
            currentCard.style.opacity = currentOpacity;

            // Show and transform next card if it exists
            if (nextCard && nextIndex >= 0 && nextIndex < totalCards) {
                nextCard.classList.remove('hidden');
                nextCard.style.transition = 'none';

                const nextProgress = 1 - Math.abs(progress);
                const nextScale = 0.85 + Math.abs(progress) * 0.15;
                const nextTranslate = (diff > 0 ? 1 : -1) * 30 * nextProgress;
                const nextOpacity = Math.abs(progress);

                nextCard.style.transform = `translateX(${nextTranslate}%) scale(${nextScale})`;
                nextCard.style.opacity = nextOpacity;
            }
        }, { passive: true });

        cardContainer.addEventListener('touchend', (e) => {
            if (!isDragging || touchStartedInScrollable || touchStartedInInk) {
                touchStartedInScrollable = false;
                touchStartedInInk = false;
                return;
            }

            isDragging = false;
            const diff = touchStartX - touchCurrentX;
            const currentCard = cards[currentCardIndex];
            const nextIndex = currentCardIndex + (diff > 0 ? 1 : -1);
            const nextCard = cards[nextIndex];

            // Re-enable transitions
            currentCard.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            if (nextCard) {
                nextCard.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            }

            if (Math.abs(diff) > swipeThreshold && nextIndex >= 0 && nextIndex < totalCards) {
                // Complete the swipe
                currentCard.style.transform = `translateX(${diff > 0 ? -30 : 30}%) scale(0.85)`;
                currentCard.style.opacity = '0';

                if (nextCard) {
                    nextCard.style.transform = 'translateX(0) scale(1)';
                    nextCard.style.opacity = '1';
                }

                // Pause video if leaving card 0
                if (currentCardIndex === 0 && parkingLotVideo) {
                    parkingLotVideo.pause();
                    parkingLotVideo.currentTime = 0;
                }

                setTimeout(() => {
                    currentCard.classList.add('hidden');
                    currentCard.classList.remove('flipped');
                    currentCard.style.transform = '';
                    currentCard.style.opacity = '';
                    currentCard.style.transition = '';

                    if (nextCard) {
                        nextCard.style.transform = '';
                        nextCard.style.opacity = '';
                        nextCard.style.transition = '';
                    }

                    currentCardIndex = nextIndex;

                    prevBtn.disabled = currentCardIndex === 0;
                    nextBtn.disabled = currentCardIndex === totalCards - 1;

                    // Update timeline milestones
                    timelineMilestones.forEach((milestone, index) => {
                        if (index === currentCardIndex) {
                            milestone.classList.add('active');
                            milestone.classList.add('passed');
                        } else if (index < currentCardIndex) {
                            milestone.classList.remove('active');
                            milestone.classList.add('passed');
                        } else {
                            milestone.classList.remove('active', 'passed');
                        }
                    });

                    // Update timeline fill with transition
                    const finalProgress = currentCardIndex / (totalCards - 1);
                    updateTimelineProgress(finalProgress, true);

                    if (currentCardIndex === 3 && typeof initInvisibleInk === 'function') {
                        initInvisibleInk();
                    }
                }, 300);
            } else {
                // Snap back
                currentCard.style.transform = 'translateX(0) scale(1)';
                currentCard.style.opacity = '1';

                // Snap timeline back to current position
                const currentProgress = currentCardIndex / (totalCards - 1);
                updateTimelineProgress(currentProgress, true);

                if (nextCard) {
                    nextCard.style.transform = `translateX(${diff > 0 ? 30 : -30}%) scale(0.85)`;
                    nextCard.style.opacity = '0';

                    setTimeout(() => {
                        nextCard.classList.add('hidden');
                        nextCard.style.transform = '';
                        nextCard.style.opacity = '';
                        nextCard.style.transition = '';
                    }, 300);
                }

                setTimeout(() => {
                    currentCard.style.transform = '';
                    currentCard.style.opacity = '';
                    currentCard.style.transition = '';
                }, 300);
            }

            touchStartedInScrollable = false;
            touchStartedInInk = false;
        }, { passive: true });

        // Enable scrolling on message-chain
        const messageChain = document.querySelector('.message-chain');
        if (messageChain) {
            let startY = 0;
            let scrollTop = 0;

            messageChain.addEventListener('touchstart', (e) => {
                startY = e.touches[0].pageY;
                scrollTop = messageChain.scrollTop;
            }, { passive: true });

            messageChain.addEventListener('touchmove', (e) => {
                const y = e.touches[0].pageY;
                const diff = startY - y;
                messageChain.scrollTop = scrollTop + diff;
            }, { passive: true });
        }

        // Card 0 flip handler with video control
        const parkingLotVideo = document.getElementById('parkingLotVideo');

        function flipCard0(card) {
            const wasFlipped = card.classList.contains('flipped');
            card.classList.toggle('flipped');

            if (!wasFlipped) {
                // Flipping to back - play video
                parkingLotVideo.play();
            } else {
                // Flipping to front - pause and reset video
                parkingLotVideo.pause();
                parkingLotVideo.currentTime = 0;
            }
        }

        // Card 3 flip handler
        function flipCard2(card) {
            const wasFlipped = card.classList.contains('flipped');
            card.classList.toggle('flipped');
            // If flipping back to front, reset the ink
            if (wasFlipped) {
                resetInvisibleInk();
            }
        }

        // Invisible ink particle effect
        let inkInitialized = false;
        let inkResetFn = null;

        function resetInvisibleInk() {
            if (inkResetFn) inkResetFn();
        }

        function initInvisibleInk() {
            if (inkInitialized) return;

            const inkContainer = document.getElementById('invisibleInk');
            const inkCanvas = document.getElementById('inkCanvas');
            if (!inkCanvas || !inkContainer) return;

            const rect = inkContainer.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) return;

            inkInitialized = true;

            const ctx = inkCanvas.getContext('2d');
            let particles = [];
            let mouseX = -1000, mouseY = -1000;
            let isInteracting = false;
            const colors = ['#6495ED', '#FFB6C1', '#FFDAB9', '#87CEEB', '#DB7093'];
            const pushRadius = 70;
            const pushStrength = 100;
            const springStrength = 0.015;
            const friction = 0.92;

            function resizeCanvas() {
                const rect = inkContainer.getBoundingClientRect();
                inkCanvas.width = rect.width * window.devicePixelRatio;
                inkCanvas.height = rect.height * window.devicePixelRatio;
                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                initParticles();
            }

            function initParticles() {
                particles = [];
                const rect = inkContainer.getBoundingClientRect();
                const numParticles = Math.floor((rect.width * rect.height) / 12);

                for (let i = 0; i < numParticles; i++) {
                    const x = Math.random() * rect.width;
                    const y = Math.random() * rect.height;
                    particles.push({
                        x: x,
                        y: y,
                        baseX: x,
                        baseY: y,
                        vx: 0,
                        vy: 0,
                        size: Math.random() * 4 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        phase: Math.random() * Math.PI * 2
                    });
                }
            }

            function animate() {
                const rect = inkContainer.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);

                const time = Date.now() * 0.002;

                particles.forEach((p) => {
                    // Push away from touch point
                    if (isInteracting) {
                        const dx = p.x - mouseX;
                        const dy = p.y - mouseY;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < pushRadius && dist > 0) {
                            const force = (pushRadius - dist) / pushRadius;
                            const angle = Math.atan2(dy, dx);
                            p.vx += Math.cos(angle) * force * pushStrength * 0.1;
                            p.vy += Math.sin(angle) * force * pushStrength * 0.1;
                        }
                    } else {
                        // Spring back to base position only when not interacting
                        const springX = (p.baseX - p.x) * springStrength;
                        const springY = (p.baseY - p.y) * springStrength;
                        p.vx += springX;
                        p.vy += springY;
                    }

                    // Apply friction
                    p.vx *= friction;
                    p.vy *= friction;

                    // Update position
                    p.x += p.vx;
                    p.y += p.vy;

                    // Gentle floating movement
                    const floatX = Math.sin(time + p.phase) * 2;
                    const floatY = Math.cos(time + p.phase * 0.7) * 2;

                    // Draw particle at current position
                    ctx.beginPath();
                    ctx.arc(p.x + floatX, p.y + floatY, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }

            function getEventPos(e) {
                const rect = inkContainer.getBoundingClientRect();
                if (e.touches) {
                    return {
                        x: e.touches[0].clientX - rect.left,
                        y: e.touches[0].clientY - rect.top
                    };
                }
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            const inkHint = inkContainer.querySelector('.invisible-ink-hint');

            inkContainer.addEventListener('touchstart', (e) => {
                isInteracting = true;
                const pos = getEventPos(e);
                mouseX = pos.x;
                mouseY = pos.y;
                if (inkHint) inkHint.classList.add('hidden');
                e.stopPropagation();
            }, { passive: true });

            inkContainer.addEventListener('touchmove', (e) => {
                const pos = getEventPos(e);
                mouseX = pos.x;
                mouseY = pos.y;
                e.stopPropagation();
            }, { passive: true });

            inkContainer.addEventListener('touchend', () => {
                isInteracting = false;
                mouseX = -1000;
                mouseY = -1000;
            }, { passive: true });

            inkContainer.addEventListener('mousedown', (e) => {
                isInteracting = true;
                const pos = getEventPos(e);
                mouseX = pos.x;
                mouseY = pos.y;
                if (inkHint) inkHint.classList.add('hidden');
                e.stopPropagation();
            });

            inkContainer.addEventListener('mousemove', (e) => {
                if (isInteracting) {
                    const pos = getEventPos(e);
                    mouseX = pos.x;
                    mouseY = pos.y;
                }
            });

            inkContainer.addEventListener('mouseup', () => {
                isInteracting = false;
                mouseX = -1000;
                mouseY = -1000;
            });

            inkContainer.addEventListener('mouseleave', () => {
                isInteracting = false;
                mouseX = -1000;
                mouseY = -1000;
            });

            window.addEventListener('resize', resizeCanvas);

            // Reset function
            inkResetFn = function() {
                initParticles();
                if (inkHint) inkHint.classList.remove('hidden');
            };

            // Initialize and start animation
            resizeCanvas();
            animate();
        }

        // Floating hearts animation
        function createFloatingHearts() {
            const container = document.getElementById('floatingHearts');
            const colors = ['#FFB6C1', '#DB7093', '#FF69B4', '#FFC0CB', '#6495ED'];
            const heartSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;

            function spawnHeart() {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = heartSVG;

                const size = Math.random() * 20 + 10;
                const left = Math.random() * 100;
                const duration = (Math.random() * 10 + 15) * 3; // 3x slower
                const delay = Math.random() * 5;

                heart.style.cssText = `
                    left: ${left}%;
                    width: ${size}px;
                    height: ${size}px;
                    color: ${colors[Math.floor(Math.random() * colors.length)]};
                    animation-duration: ${duration}s;
                    animation-delay: ${delay}s;
                `;

                container.appendChild(heart);

                // Remove heart after animation completes
                setTimeout(() => {
                    heart.remove();
                }, (duration + delay) * 1000);
            }

            // Initial batch of hearts (27 hearts)
            for (let i = 0; i < 27; i++) {
                setTimeout(() => spawnHeart(), i * 100);
            }

            // Continue spawning hearts (3 every 1.5 seconds)
            setInterval(() => {
                for (let i = 0; i < 3; i++) {
                    setTimeout(spawnHeart, i * 50);
                }
            }, 1500);
        }

        // Start floating hearts
        createFloatingHearts();

        // Confetti celebration - only triggers once per session
        let confettiTriggered = false;

        function triggerConfetti() {
            if (confettiTriggered) return;
            confettiTriggered = true;

            const container = document.getElementById('confettiContainer');
            const colors = ['#FFB6C1', '#6495ED', '#FFDAB9', '#87CEEB', '#DB7093', '#FFD700', '#FF69B4'];
            const shapes = ['circle', 'square', 'triangle'];

            for (let i = 0; i < 400; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';

                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const left = Math.random() * 100;
                    const size = Math.random() * 8 + 6;
                    const delay = Math.random() * 0.25;
                    const duration = Math.random() * 2 + 2;

                    let shapeStyle = '';
                    if (shape === 'circle') {
                        shapeStyle = 'border-radius: 50%;';
                    } else if (shape === 'triangle') {
                        shapeStyle = `
                            width: 0;
                            height: 0;
                            border-left: ${size/2}px solid transparent;
                            border-right: ${size/2}px solid transparent;
                            border-bottom: ${size}px solid ${color};
                            background: transparent;
                        `;
                    }

                    confetti.style.cssText = `
                        left: ${left}%;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${shape !== 'triangle' ? color : 'transparent'};
                        ${shapeStyle}
                        animation: confettiFall ${duration}s ease-out ${delay}s forwards;
                    `;

                    container.appendChild(confetti);

                    // Cleanup after animation
                    setTimeout(() => confetti.remove(), (duration + delay + 1) * 1000);
                }, i * 10);
            }
            // Note: confettiTriggered stays true - confetti only plays once per session
        }

        // Watch for engagement card (card 6) becoming visible
        const engagementCardObserver = new MutationObserver((mutations) => {
            const engagementCard = document.querySelector('.card[data-card="6"]');
            if (engagementCard && !engagementCard.classList.contains('hidden')) {
                triggerConfetti();
            }
        });

        // Observe card visibility changes
        document.querySelectorAll('.card').forEach(card => {
            engagementCardObserver.observe(card, { attributes: true, attributeFilter: ['class'] });
        });

        // ========== GYROSCOPIC PARTICLE SYSTEM ==========

        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        const permissionBtn = document.getElementById('motionPermissionBtn');

        let particles = [];
        let deviceTilt = { x: 0, y: 0 };
        let motionEnabled = false;

        // Resize canvas to fill screen
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Particle class
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.baseX = this.x;
                this.baseY = this.y;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;

                // Color palette from Wedding Wrapped theme
                const colors = [
                    'rgba(100, 149, 237, 0.6)', // Cornflower Blue
                    'rgba(255, 182, 193, 0.6)', // Light Pink
                    'rgba(255, 218, 185, 0.6)', // Peach Puff
                    'rgba(135, 206, 235, 0.5)', // Light Blue
                ];
                this.color = colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                // Gyroscope influence (stronger effect)
                const tiltInfluence = 3;
                const targetX = this.baseX + (deviceTilt.x * tiltInfluence);
                const targetY = this.baseY + (deviceTilt.y * tiltInfluence);

                // Smooth movement toward tilt position
                this.x += (targetX - this.x) * 0.05;
                this.y += (targetY - this.y) * 0.05;

                // Gentle drift
                this.baseX += this.speedX;
                this.baseY += this.speedY;

                // Wrap around edges
                if (this.baseX > canvas.width + 50) this.baseX = -50;
                if (this.baseX < -50) this.baseX = canvas.width + 50;
                if (this.baseY > canvas.height + 50) this.baseY = -50;
                if (this.baseY < -50) this.baseY = canvas.height + 50;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Create particles
        function initParticles() {
            particles = [];
            const particleCount = Math.min(100, Math.floor((canvas.width * canvas.height) / 15000));
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }
        initParticles();

        // Animation loop
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            requestAnimationFrame(animate);
        }
        animate();

        // Handle device orientation
        function handleOrientation(event) {
            if (!motionEnabled) return;

            // Beta: front-to-back tilt (-180 to 180)
            // Gamma: left-to-right tilt (-90 to 90)
            const beta = event.beta || 0;  // Y axis
            const gamma = event.gamma || 0; // X axis

            // Normalize and scale
            deviceTilt.x = Math.max(-30, Math.min(30, gamma));
            deviceTilt.y = Math.max(-30, Math.min(30, beta - 45)); // Offset for natural holding angle
        }

        // Check if device supports motion
        function checkMotionSupport() {
            // iOS 13+ requires permission
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // Show button for iOS
                permissionBtn.style.display = 'block';
                permissionBtn.addEventListener('click', requestMotionPermission);
            }
            // Android and older iOS - just enable
            else if (window.DeviceOrientationEvent) {
                enableMotion();
            }
        }

        // Request permission (iOS 13+)
        async function requestMotionPermission() {
            try {
                console.log('Requesting motion permission...');
                const permission = await DeviceOrientationEvent.requestPermission();
                console.log('Permission result:', permission);

                if (permission === 'granted') {
                    enableMotion();
                    permissionBtn.style.display = 'none';
                } else {
                    // Permission denied
                    permissionBtn.textContent = 'Go to Settings â†’ Safari â†’ Motion & Orientation';
                    permissionBtn.style.fontSize = '11px';
                    permissionBtn.style.padding = '12px 20px';
                    console.log('Permission denied by user');
                }
            } catch (error) {
                console.error('Error requesting motion permission:', error);
                permissionBtn.textContent = 'Error: ' + error.message;
                permissionBtn.style.fontSize = '12px';

                // If HTTPS required
                if (error.message.includes('secure') || error.message.includes('https')) {
                    setTimeout(() => {
                        permissionBtn.textContent = 'HTTPS Required for Motion';
                    }, 3000);
                }
            }
        }

        // Enable motion tracking
        function enableMotion() {
            motionEnabled = true;
            window.addEventListener('deviceorientation', handleOrientation);
            console.log('Gyroscopic particles enabled!');
        }

        // Initialize on load
        checkMotionSupport();
    </script>
</body>
</html>
